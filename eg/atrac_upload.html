<!DOCTYPE html>
<html>
<head>
    <title>
        ATRAC Upload form
    </title>
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" media="screen" rel="stylesheet" />
    <script src="//code.jquery.com/jquery-1.9.1.min.js"></script>
</head>
<body>
    <h1>ATRAC Image Metadata Upload Form</h1>
    <div class="content">
        <form class="form-horizontal" id='atracform' method="POST" enctype="multipart/form-data">
        <div class="control-group">
            <label class="control-label" for="chapter">Report</label>
            <div class="controls"> <select name='report' id="report"></select>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label" for="chapter">Chapter</label>
            <div class="controls"> <select name='chapter' id="chapter">
                    <option value="">--select--</option>
            </select>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="figure">Figure</label>
            <div class="controls"> <input type="text" name='figure' id="figure" placeholder="figure identifier"></input> </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="image">Image</label>
            <div class="controls"> <input type="text" name='image' id="image" placeholder="image identifier"></input> </div>
        </div>
        <div class="control-group">
            <label class="control-label" for="atracfile">ATRAC File</label>
            <div class="controls">
                <span class="btn btn-file"><input type="file" name='atracfile' /></span>
            </div>
        </div>
        <div class="control-group">
            <div class="controls">
                <input type="submit" class="btn btn-primary" name="upload" value="Upload"
                onClick="set_action(); document.forms[0].submit(); "></input>
            </div>
        </div>

    </form>
    </div>
    <script type='text/javascript'>
    var tuba = 'http://localhost:3000';

    function populate_chapter() {
        $.ajax({
                type     : "GET",
                url      : tuba + '/report/' + $('#report').val() + '/chapter',
                dataType : 'json',
                headers  : { Accept : "application/json" },
                error    : function(e,z) { console.log('error',e,z); alert('error getting chapters (see console)') },
                }
              ).success(function(results){
                  $.each(results, function(i,result){
                      $('#chapter').append(
                          '<option value="' + result.identifier + '">' + result.identifier + '</option>');
                  })
               });
    }

    function populate_report() {
        $.ajax({
                type     : "GET",
                url      : tuba + '/report',
                dataType : 'json',
                headers  : { Accept : "application/json" },
                error    : function(e,z) { console.log('error',e,z); alert('error getting report (see console)') },
                }
              ).success(function(results){
                  $.each(results, function(i,result){
                      $('#report').append(
                          '<option value="' + result.identifier + '" selected>' + result.identifier + '</option>');
                  });
                  populate_chapter();
                }
                );
    }

    function set_action() {
        var img = $('#image').val();
        var action = tuba + '/image/' + img + '/setmet';
        console.log('action is ' + action);
        document.forms[0].action = action;
    }

    $(document).ready(function() {
            $(function() {
                $.ajaxSetup({
                    error: function(jqXHR, exception) {
                        if (jqXHR.status === 0) {
                            alert('Not connect.\n Verify Network.');
                        } else if (jqXHR.status == 404) {
                            alert('Requested page not found. [404]');
                        } else if (jqXHR.status == 500) {
                            alert('Internal Server Error [500].');
                        } else if (exception === 'parsererror') {
                            alert('Requested JSON parse failed.');
                        } else if (exception === 'timeout') {
                            alert('Time out error.');
                        } else if (exception === 'abort') {
                            alert('Ajax request aborted.');
                        } else {
                            alert('Uncaught Error.\n' + jqXHR.responseText);
                        }
                    }
                });
            });
            populate_report();
    });
    </script>
</body>
</html>
